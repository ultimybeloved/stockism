# Stockism Project Context

> **Auto-loaded context file for Claude Code sessions**
> This file ensures Claude always understands the project architecture, deployment workflow, and critical context.

---

## Project Overview

**Stockism** is a social stock market simulation game where players trade fictional stocks of characters from the Lookism webtoon series. Features include real-time trading, short selling, margin trading, crews system, predictions market, IPO system, achievements, leaderboards, and a ladder game mini-game.

**Live URL:** https://stockism.app
**Repository:** https://github.com/ultimybeloved/stockism
**Status:** Production, actively maintained

---

## Critical Architecture - READ THIS FIRST

### Deployment Infrastructure

**IMPORTANT - Three Separate Systems:**

1. **Vercel** (Main Deployment Platform)
   - Hosts the entire frontend React app
   - Auto-deploys on every GitHub push to `main` branch
   - Serves all user-facing pages and assets
   - Location: https://stockism.app

2. **Firestore** (Data Storage & Backend ONLY)
   - Database for all game data (users, market prices, trades, etc.)
   - Cloud Functions for serverside logic
   - Security rules and validation
   - **NOT a deployment platform** - just storage + serverless functions

3. **GitHub** (Source of Truth)
   - All code lives here
   - Vercel watches this repo for changes
   - Must push here before anything goes live

### Deployment Workflow - CRITICAL

**For Frontend Changes (React, UI, components):**
```
1. Make changes locally
2. Test with `npm run dev`
3. git add . && git commit -m "message"
4. git push
5. Vercel auto-deploys (takes ~2 minutes)
6. Changes are LIVE at stockism.app
```

**For Firestore Changes (security rules, indexes, Cloud Functions):**
```
1. Edit functions/index.js or firestore.rules
2. Test locally if possible
3. git add . && git commit -m "message"
4. git push (saves to GitHub)
5. cd functions && firebase deploy --only functions
   OR: firebase deploy --only firestore:rules
6. Changes are LIVE in Firebase
```

**NEVER assume changes are live unless:**
- âœ… Committed to GitHub
- âœ… Pushed to origin
- âœ… Vercel deployed (for frontend) OR Firebase deployed (for functions/rules)

---

## Folder Structure

```
stockism/
â”œâ”€â”€ .claude/                      # Claude Code settings
â”‚   â””â”€â”€ settings.local.json       # Local Claude config
â”œâ”€â”€ .firebase/                    # Firebase CLI cache (gitignored)
â”œâ”€â”€ .git/                         # Git repository
â”œâ”€â”€ dist/                         # Vite build output (gitignored, generated by `npm run build`)
â”‚   â”œâ”€â”€ assets/                   # Built JS/CSS bundles
â”‚   â”œâ”€â”€ crews/                    # Crew images (copied from public/)
â”‚   â””â”€â”€ pins/                     # Achievement pin images
â”œâ”€â”€ functions/                    # Firebase Cloud Functions (Node.js)
â”‚   â”œâ”€â”€ node_modules/             # Function dependencies
â”‚   â”œâ”€â”€ index.js                  # Main functions file (85KB, 2700+ lines)
â”‚   â”œâ”€â”€ botTrader.js              # Bot trading logic
â”‚   â”œâ”€â”€ contentGeneration.js      # YouTube Shorts content generation
â”‚   â”œâ”€â”€ videoGenerator.js         # Video rendering (canvas + ffmpeg)
â”‚   â”œâ”€â”€ package.json              # Function dependencies
â”‚   â””â”€â”€ package-lock.json         # Locked versions
â”œâ”€â”€ public/                       # Static assets (copied to dist/ on build)
â”‚   â”œâ”€â”€ crews/                    # Crew logos (Big Deal, Hostel, Workers, etc.)
â”‚   â”œâ”€â”€ pins/                     # Achievement pins
â”‚   â”œâ”€â”€ favicon.png               # Site icon
â”‚   â””â”€â”€ stockism logo.png         # Main logo
â”œâ”€â”€ scripts/                      # Utility scripts
â”‚   â”œâ”€â”€ migrateUsernames.js       # One-time migration script
â”‚   â””â”€â”€ package.json              # Script dependencies
â”œâ”€â”€ src/                          # React frontend source code
â”‚   â”œâ”€â”€ components/               # Reusable React components
â”‚   â”‚   â”œâ”€â”€ common/               # Shared UI (Modal, Button, Card, Loading)
â”‚   â”‚   â”œâ”€â”€ charts/               # Price chart components
â”‚   â”‚   â”œâ”€â”€ trading/              # Trading UI components
â”‚   â”‚   â”œâ”€â”€ activity/             # Activity feed
â”‚   â”‚   â”œâ”€â”€ modals/               # Modal dialogs
â”‚   â”‚   â”œâ”€â”€ ipo/                  # IPO system UI
â”‚   â”‚   â”œâ”€â”€ predictions/          # Predictions market UI
â”‚   â”‚   â”œâ”€â”€ layout/               # Layout components
â”‚   â”‚   â”œâ”€â”€ ContentQueueTab.jsx   # Admin content review (YouTube Shorts)
â”‚   â”‚   â””â”€â”€ LadderGame.jsx        # Ladder game mini-game
â”‚   â”œâ”€â”€ config/                   # Configuration files
â”‚   â”œâ”€â”€ constants/                # App constants (ADMIN_UIDS, MIN_PRICE, etc.)
â”‚   â”œâ”€â”€ context/                  # React Context providers (Auth, Market, Theme)
â”‚   â”œâ”€â”€ data/                     # Static data files
â”‚   â”œâ”€â”€ hooks/                    # Custom React hooks (useAuth, useMarket, etc.)
â”‚   â”œâ”€â”€ pages/                    # Page components
â”‚   â”œâ”€â”€ services/                 # Firebase service wrappers (market, trading, user, auth)
â”‚   â”œâ”€â”€ utils/                    # Utility functions (formatters, calculations)
â”‚   â”œâ”€â”€ App.jsx                   # Main app component (437KB, massive file)
â”‚   â”œâ”€â”€ AdminPanel.jsx            # Admin panel (234KB, 5200+ lines)
â”‚   â”œâ”€â”€ characters.js             # Character data (tickers, base prices, volatility)
â”‚   â”œâ”€â”€ crews.js                  # Crew data, missions, shop items
â”‚   â”œâ”€â”€ firebase.js               # Firebase config & Cloud Function exports
â”‚   â”œâ”€â”€ index.css                 # Global Tailwind styles
â”‚   â””â”€â”€ main.jsx                  # React entry point
â”œâ”€â”€ .env.example                  # Environment variables template
â”œâ”€â”€ .gitignore                    # Git ignore rules
â”œâ”€â”€ CLAUDE.md                     # Claude Code instructions (project philosophy)
â”œâ”€â”€ CONTENT_SYSTEM_SETUP.md       # YouTube Shorts content generation docs
â”œâ”€â”€ README.md                     # Project documentation
â”œâ”€â”€ firebase.json                 # Firebase config (functions, Firestore)
â”œâ”€â”€ firestore.indexes.json        # Firestore database indexes
â”œâ”€â”€ firestore.rules               # Firestore security rules (8.5KB)
â”œâ”€â”€ index.html                    # HTML entry point (Vite)
â”œâ”€â”€ package.json                  # Frontend dependencies
â”œâ”€â”€ package-lock.json             # Locked versions
â”œâ”€â”€ postcss.config.js             # PostCSS config (Tailwind)
â”œâ”€â”€ tailwind.config.js            # Tailwind CSS config
â”œâ”€â”€ vercel.json                   # Vercel deployment config
â””â”€â”€ vite.config.js                # Vite build config
```

---

## Tech Stack

### Frontend (Deployed on Vercel)
- **React 18.2** - UI framework
- **Vite 5.1** - Build tool & dev server
- **Tailwind CSS 3.4** - Styling
- **Firebase SDK 10.8** - Client-side Firebase integration
- **Responsive Design** - Mobile-first, works on all devices

### Backend (Firebase Cloud Functions + Firestore)
- **Node.js 20** - Runtime for Cloud Functions
- **Firestore** - NoSQL database for all game data
- **Firebase Cloud Functions** - Serverless API endpoints
- **Firebase Authentication** - Google, Twitter, Email/Password
- **Firebase App Check** - ReCaptcha V3 protection
- **Firebase Cloud Storage** - Video storage for content generation

### Build & Deploy
- **Vercel** - Frontend hosting & deployment
- **GitHub** - Version control & CI/CD trigger
- **Firebase CLI** - Deploy functions & Firestore rules
- **npm** - Package manager

### Content Generation (NEW)
- **canvas 2.11** - Server-side image rendering
- **fluent-ffmpeg 2.1** - Video generation (MP4)
- **@google-cloud/storage 7.7** - Cloud Storage for videos

---

## Data Flow

```
User Browser (stockism.app via Vercel)
    â†“
React App (Frontend)
    â†“
Firebase SDK (Client-side)
    â†“
Firebase Cloud Functions (Serverless, us-central1)
    â†“
Firestore Database (NoSQL)
    â†“
Response back to User
```

**Key Collections in Firestore:**
- `users` - User accounts, portfolios, holdings, cash
- `market/current` - Current prices, price history, volumes
- `trades` - Trade audit log
- `predictions` - Predictions market data
- `ipos` - Active and completed IPOs
- `contentQueue` - Generated videos for YouTube Shorts
- `ladderGameUsers` - Ladder game player data
- `ladderGame/global` - Global ladder game history

---

## Recent Major Changes

### January 2026
- âœ… **Content Generation System** - Auto-generates YouTube Shorts videos for marketing
  - Character spotlights when price moves >15%
  - Daily market movers (top gainers/losers)
  - Drama events (liquidations, achievements)
  - Admin review queue in Admin Panel
  - Cloud Functions: `generateMarketContent`, `generateDailyMovers`, `generateDramaVideo`

- âœ… **Ladder Game** - Mini-game with separate $500 balance
  - One-way deposits from main Stockism cash
  - Server-side RNG (prevents cheating)
  - Real-time global history and leaderboard
  - Animated ladder game UI

- âœ… **Discord Alerts** - Real-time notifications
  - Price spikes, achievements, liquidations
  - Admin price adjustments
  - Daily/weekly market summaries

- âœ… **Security Hardening**
  - Trade validation (server-side)
  - Anti-exploit measures (cooldowns, hold periods)
  - Profanity filter for usernames
  - Firebase App Check with ReCaptcha V3

---

## Important Files & What They Do

### Core App Files
- **`src/App.jsx`** - Main app logic, routing, trading system (437KB - HUGE file)
- **`src/AdminPanel.jsx`** - Admin interface, 9 tabs for game management (234KB)
- **`src/firebase.js`** - Firebase initialization, Cloud Function exports
- **`src/characters.js`** - 90+ characters with tickers, base prices, volatility
- **`src/crews.js`** - 9 crews (Big Deal, Hostel, Workers, Allied, WTJC, God Dog, Fist Gang, Secret Friends, Yamazaki), daily/weekly missions, shop items

### Backend Functions
- **`functions/index.js`** - All Cloud Functions (85KB, 2700+ lines)
  - User management (createUser, deleteAccount, banUser)
  - Market functions (dailyMarketSummary, hourlyMovers, priceThresholdAlert)
  - Trading (validateTrade, recordTrade, anti-exploit)
  - Discord alerts (tradeSpikeAlert, achievementAlert, marginLiquidationAlert)
  - IPO system (not in separate file, integrated)
  - Predictions (not in separate file, integrated)
  - Backups (automated + manual, with restore)
  - Ladder game (playLadderGame, depositToLadderGame, getLadderLeaderboard)
  - Content generation (generateMarketContent, generateDailyMovers, etc.)

- **`functions/contentGeneration.js`** - YouTube Shorts content logic
- **`functions/videoGenerator.js`** - Canvas + FFmpeg video rendering

### Config Files
- **`vercel.json`** - Vercel deployment settings (SPA rewrites, security headers)
- **`firebase.json`** - Firebase config (functions, Firestore)
- **`firestore.rules`** - Security rules (8.5KB - comprehensive)
- **`firestore.indexes.json`** - Database indexes for queries
- **`vite.config.js`** - Vite build config
- **`tailwind.config.js`** - Tailwind CSS customization

### Documentation
- **`CLAUDE.md`** - Claude Code project instructions (philosophy, git workflow)
- **`CONTENT_SYSTEM_SETUP.md`** - Content generation system docs
- **`README.md`** - Public project documentation
- **`STOCKISM_CONTEXT.md`** - This file (persistent context)

---

## GitHub Workflow

### Standard Development Flow
```bash
# 1. Make changes locally
# Edit files in src/, functions/, or config

# 2. Test locally
npm run dev                    # Test frontend
cd functions && npm test       # Test functions (if tests exist)

# 3. Commit to GitHub
git add .
git commit -m "Brief description"  # Keep commit messages short and vague per CLAUDE.md
git push origin main

# 4. Verify deployment
# Vercel auto-deploys frontend in ~2 mins
# Check https://stockism.app

# 5. Deploy functions if needed
cd functions
firebase deploy --only functions

# 6. Deploy Firestore rules if changed
firebase deploy --only firestore:rules
```

### Git Commit Guidelines (from CLAUDE.md)
- **Do NOT add "Co-Authored-By: Claude"** to commits
- Keep messages **short and vague** (e.g., "Update portfolio", "Fix bug", "Add feature")
- No jargon or over-explanation

### Branch Strategy
- **main** - Production branch, auto-deploys to Vercel
- No feature branches currently (direct to main)

---

## Claude-Specific Tips & Reminders

### ðŸš¨ CRITICAL - Always Remember:

1. **Vercel is the deployment platform, Firestore is storage only**
   - Frontend changes â†’ GitHub â†’ Vercel auto-deploys
   - Function/rule changes â†’ GitHub â†’ Firebase CLI deploy
   - Never say "deploy to Firebase" for frontend code

2. **Changes are NOT live until pushed to GitHub**
   - Local changes are sandbox only
   - Don't assume code is running in production
   - Always ask "Did you push to GitHub?" before debugging "live" issues

3. **Deployment checklist:**
   - âœ… Code committed to git
   - âœ… Pushed to GitHub (origin/main)
   - âœ… Vercel deployed (for frontend) - check Vercel dashboard
   - âœ… Firebase deployed (for functions/rules) - run `firebase deploy`

4. **Never skip these steps:**
   - Read files before editing (Edit tool requires Read first)
   - Test locally before deploying
   - Commit to GitHub before claiming something is "done"
   - Verify deployment status before debugging production issues

5. **Common mistakes to avoid:**
   - âŒ "Let me deploy this to Firebase" (for frontend code)
   - âŒ "This is now live" (before GitHub push)
   - âŒ "The changes are on Firestore" (Firestore is a database, not a deployment platform)
   - âœ… "Let me push to GitHub so Vercel can deploy"
   - âœ… "After you push, Vercel will auto-deploy in ~2 minutes"
   - âœ… "I'll update Firestore data/rules and you can deploy with Firebase CLI"

### File Size Warnings
- **App.jsx is 437KB** - This is the main app file, contains most trading logic
- **AdminPanel.jsx is 234KB** - This is the admin interface, 5200+ lines
- **functions/index.js is 85KB** - All Cloud Functions in one file
- When reading these files, use `offset` and `limit` parameters

### Architecture Decisions
- **Monolithic App.jsx** - All trading logic in one file for simplicity
- **No Redux** - Uses React Context for state management
- **No TypeScript** - Plain JavaScript for faster development
- **Tailwind only** - No CSS modules or styled-components
- **Firebase only** - No custom backend server

### Testing Strategy
- **No automated tests** - Manual testing only
- **Test locally first** - Use `npm run dev` before deploying
- **Admin panel** - Use admin tools to test features in production
- **Bot traders** - 28 bots simulate real trading activity

---

## Common Tasks & Commands

### Development
```bash
npm run dev              # Start local dev server (http://localhost:5173)
npm run build            # Build for production (outputs to dist/)
npm run preview          # Preview production build locally
```

### Deployment
```bash
# Frontend (automatic via Vercel)
git push origin main     # Vercel auto-deploys

# Cloud Functions
cd functions
firebase deploy --only functions

# Firestore Security Rules
firebase deploy --only firestore:rules

# Everything Firebase (functions + rules + indexes)
firebase deploy
```

### Firebase CLI
```bash
firebase login                      # Authenticate
firebase projects:list              # List projects
firebase use stockism-abb28         # Switch project
firebase functions:log              # View function logs
firebase functions:config:get       # View config (e.g., Discord tokens)
```

### Git
```bash
git status                          # Check changes
git add .                           # Stage all changes
git commit -m "message"             # Commit (keep message vague)
git push origin main                # Push to GitHub (triggers Vercel deploy)
git log --oneline -10               # View recent commits
```

---

## Environment Variables

### Local Development (.env - gitignored)
```
VITE_FIREBASE_API_KEY=...
VITE_FIREBASE_AUTH_DOMAIN=...
VITE_FIREBASE_PROJECT_ID=stockism-abb28
VITE_FIREBASE_STORAGE_BUCKET=...
VITE_FIREBASE_MESSAGING_SENDER_ID=...
VITE_FIREBASE_APP_ID=...
VITE_FIREBASE_MEASUREMENT_ID=...
VITE_RECAPTCHA_SITE_KEY=...
```

### Cloud Functions (set via Firebase CLI)
```bash
firebase functions:config:set discord.bot_token="..."
firebase functions:config:set discord.channel_id="..."
```

### Vercel (set in Vercel dashboard)
- Same as local .env but managed in Vercel UI
- Auto-injected during build

---

## Key Features & Systems

### Trading System
- **Real-time prices** - Shared global prices with price impact model
- **Long positions** - Buy and sell with cost basis tracking
- **Short selling** - 50% margin requirement, 0.1% daily interest
- **Margin trading** - Leverage system with auto-liquidation
- **Price impact** - Square root impact model with bid/ask spreads
- **Trade validation** - Server-side with 3-second cooldown, 45-second hold period

### Crews System
- **9 crews** - Big Deal, Hostel, Workers, Allied, WTJC, God Dog, Fist Gang, Secret Friends, Yamazaki
- **Daily missions** - 3 per day, $75-$200 rewards
- **Weekly missions** - 2 per week, $400-$1000 rewards
- **Crew dividends** - NOT YET IMPLEMENTED (planned feature)

### Predictions Market
- **Community predictions** - Pool-based betting
- **Winners split pot** - Proportional to bet size
- **Admin-created** - Admin sets questions and resolves outcomes

### IPO System
- **Hype phase** - 24-hour announcement before trading
- **Limited window** - 24-hour IPO buying period
- **Price jump** - 30% increase after IPO closes
- **One-time only** - Each character can only IPO once

### Achievements System
- **20+ achievements** - Various milestones and challenges
- **Discord alerts** - Notify when players unlock achievements
- **Collectible pins** - Visual badges for profile

### Ladder Game (Mini-game)
- **Separate balance** - $500 starting balance, deposits from main cash
- **Server-side RNG** - Prevents cheating
- **Odd/Even betting** - 2-3 rungs, paths cross on odd rungs
- **Leaderboard** - Global top 50 by balance

### Content Generation (Marketing)
- **Auto-generated videos** - YouTube Shorts format (1080x1920)
- **Character spotlights** - When price moves >15%
- **Daily market movers** - Top gainers/losers
- **Admin review** - Queue in Admin Panel before posting

---

## Admin Panel Features (9 Tabs)

1. **ðŸš€ IPO** - Create and manage IPOs
2. **ðŸŽ² Bets** - Create and resolve predictions
3. **ðŸ“Š Holders** - View who holds each stock
4. **ðŸ‘¥ Users** - Search, edit, delete users
5. **ðŸ¤– Bots** - Manage bot traders
6. **ðŸ’¹ Trades** - View trade history
7. **ðŸ“ˆ Stats** - Market statistics
8. **ðŸ”§ Recovery** - Price adjustments, backups, fraud detection
9. **ðŸŽ¬ Content** - Review generated videos for YouTube

---

## Performance & Scale

### Current Scale
- **90+ tradeable characters**
- **28 bot traders** - Simulate realistic market activity
- **Real-time updates** - Firestore listeners for live prices
- **Complex calculations** - Price impact, margin calculations, portfolio values

### Optimization Notes
- **Large bundle size** - Main JS bundle is ~994KB (needs code splitting)
- **No lazy loading** - All components loaded upfront
- **Firestore reads** - Optimized with real-time listeners (not polling)
- **Cloud Functions** - Scheduled jobs for market summaries, content generation

---

## Security

### Firebase App Check
- **ReCaptcha V3** - Protects Cloud Functions from abuse
- **Production only** - Debug tokens for local dev

### Trade Validation
- **Server-side validation** - All trades verified in Cloud Functions
- **Cooldowns** - 3-second trade cooldown, 45-second hold period
- **Anti-exploit** - Prevents rapid trading, pump-and-dump

### Firestore Rules
- **Comprehensive rules** - 8.5KB of security rules
- **Read permissions** - Market data public, user data private
- **Write permissions** - Only via Cloud Functions (users can't write directly)

### Authentication
- **Google Sign-In**
- **Twitter Sign-In**
- **Email/Password**
- **Admin-only** - Restricted UIDs for admin functions

---

## Troubleshooting

### Common Issues

**"Changes not showing on stockism.app"**
- âœ… Did you push to GitHub?
- âœ… Check Vercel deployment dashboard
- âœ… Clear browser cache (Ctrl+Shift+R)

**"Cloud Function not working"**
- âœ… Did you deploy functions? (`firebase deploy --only functions`)
- âœ… Check function logs: `firebase functions:log`
- âœ… Verify Firebase project is correct: `firebase use`

**"Firestore security rules blocking requests"**
- âœ… Check `firestore.rules` file
- âœ… Deploy rules: `firebase deploy --only firestore:rules`
- âœ… View Firestore dashboard â†’ Rules tab

**"Local dev server not starting"**
- âœ… Check `.env` file exists (copy from `.env.example`)
- âœ… Run `npm install` to ensure dependencies installed
- âœ… Check for port conflicts (default: 5173)

---

## Contact & Support

**Project Owner:** Darth YG (non-technical manager)
**Developer:** Claude (AI assistant)
**Repository:** https://github.com/ultimybeloved/stockism
**Live Site:** https://stockism.app

**Support Channels:**
- Discord server (for alerts and community)
- Reddit (for announcements)
- GitHub Issues (for bug reports)

---

## Version History

- **v2.0.0** - Current version (January 2026)
  - Content generation system
  - Ladder game mini-game
  - Discord alerts
  - Security hardening

- **v1.x** - Original version
  - Basic trading system
  - Crews and missions
  - Predictions market
  - IPO system

---

**Last Updated:** January 29, 2026
**Context File Version:** 1.0.1

---

## Maintenance Note for Claude

**ðŸ¤– Auto-Update Protocol:**

When you make significant changes to the project, update this file in the same session:

**Update "Recent Major Changes" when:**
- New features are added
- Major systems are modified
- Breaking changes occur
- New dependencies are added

**Update "Folder Structure" when:**
- New directories are created
- Major files are added/removed
- File purposes change significantly

**Update "Important Files & What They Do" when:**
- New core files are added
- File responsibilities change
- New Cloud Functions are added

**Update "Key Features & Systems" when:**
- Features are fully implemented
- Features are deprecated/removed
- System behavior changes

**Always increment version number** (e.g., 1.0.1 â†’ 1.0.2) when updating.

**Commit the updated STOCKISM_CONTEXT.md** to GitHub along with your code changes so it stays in sync.
